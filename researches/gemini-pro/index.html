<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Blueprint: CTF & Conference Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F0;
            /* Warm Neutral Background */
            color: #374151;
            /* Charcoal Text */
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(229, 231, 235, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .nav-item.active {
            border-bottom: 3px solid #4F46E5;
            /* Indigo-600 */
            color: #111827;
            font-weight: 600;
        }

        /* Custom scrollbar for clean look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
    <!-- Chosen Palette: Warm Professional (Warm Grey/Bone Background, White Cards, Indigo/Slate Accents) -->
    <!-- Application Structure Plan: The app is designed as an interactive "Project Command Center" dashboard. 
         1. **Strategic Overview**: High-level summary of the mission.
         2. **Intelligence Assets**: A bubble chart visualizing data source reliability vs frequency.
         3. **System Architecture**: An interactive block diagram explaining the tech stack and flow.
         4. **Operations (ETL)**: A step-by-step interactive process flow for data ingestion.
         5. **Tactical Simulation**: An interactive notification score calculator to demonstrate the personalization logic.
         6. **Mission Timeline**: A Gantt-style chart for the MVP roadmap.
         This structure moves from data acquisition -> processing -> user interaction -> execution plan. -->
    <!-- Visualization & Content Choices:
         - Data Sources: Bubble Chart (Chart.js) -> Goal: Compare sources on 3 dimensions (Reliability, Frequency, Coverage). Interactive tooltips provide specific API details.
         - Architecture: Interactive Grid Layout -> Goal: Organise complex system components. Click to reveal details (No Mermaid/SVG).
         - ETL Pipeline: Clickable Stepper (HTML/JS) -> Goal: Change view to explain sequential process steps clearly.
         - Roadmap: Bar Chart (Chart.js) -> Goal: Inform timeline/phases visually. 
         - Notification Calc: JS Form -> Goal: Relationship/Simulation of how input parameters affect alert scoring. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>

<body class="antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-slate-800 tracking-tight">üõ°Ô∏è SecOps Tracker <span
                            class="text-indigo-600 text-base font-normal ml-2">Project Blueprint</span></span>
                </div>
                <nav class="hidden md:flex space-x-8">
                    <button onclick="scrollToSection('intelligence')"
                        class="text-gray-500 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">Intelligence</button>
                    <button onclick="scrollToSection('architecture')"
                        class="text-gray-500 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">Architecture</button>
                    <button onclick="scrollToSection('operations')"
                        class="text-gray-500 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">Operations</button>
                    <button onclick="scrollToSection('timeline')"
                        class="text-gray-500 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">Timeline</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 w-full space-y-16">

        <!-- Intro Section -->
        <section class="text-center max-w-3xl mx-auto">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">CTF & Conference Tracking Platform</h1>
            <p class="text-lg text-gray-600 mb-8 leading-relaxed">
                A centralized intelligence hub designed to aggregate, normalize, and distribute critical cybersecurity
                event data.
                This platform bridges the gap between fragmented information sources (CTFtime, GitHub, Public Calendars)
                and the personalized needs of security professionals.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card p-6 rounded-xl">
                    <div class="text-3xl font-bold text-indigo-600 mb-2">5+</div>
                    <div class="text-sm text-gray-500 font-semibold uppercase tracking-wider">Data Sources</div>
                </div>
                <div class="glass-card p-6 rounded-xl">
                    <div class="text-3xl font-bold text-emerald-600 mb-2">Real-time</div>
                    <div class="text-sm text-gray-500 font-semibold uppercase tracking-wider">Ingestion</div>
                </div>
                <div class="glass-card p-6 rounded-xl">
                    <div class="text-3xl font-bold text-amber-500 mb-2">Adaptive</div>
                    <div class="text-sm text-gray-500 font-semibold uppercase tracking-wider">Notifications</div>
                </div>
            </div>
        </section>

        <!-- Section 1: Intelligence Assets (Data Sources) -->
        <section id="intelligence" class="scroll-mt-24">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <span class="bg-indigo-100 text-indigo-600 p-2 rounded-lg mr-3">üì°</span> Intelligence Assets
                </h2>
                <p class="mt-2 text-gray-600 max-w-4xl">
                    The platform operates on a "Tiered Trust" model. We prioritize high-fidelity APIs like CTFtime for
                    core event data, enriching it with community-maintained repositories and fallback scraping
                    mechanisms. The visualization below maps our primary data sources based on their reliability, update
                    frequency, and breadth of coverage.
                </p>
            </div>

            <div class="glass-card rounded-xl p-6 shadow-sm">
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Chart Column -->
                    <div class="w-full md:w-2/3">
                        <div class="chart-container">
                            <canvas id="sourceChart"></canvas>
                        </div>
                    </div>
                    <!-- Details Column -->
                    <div class="w-full md:w-1/3 flex flex-col justify-center space-y-4">
                        <div id="sourceDetails" class="bg-gray-50 rounded-lg p-6 border border-gray-100 h-full">
                            <h3 class="font-bold text-lg text-gray-800 mb-2">Source Details</h3>
                            <p class="text-gray-500 text-sm italic">Hover over a bubble to see specific technical
                                constraints, authentication requirements, and rate limits.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: System Architecture -->
        <section id="architecture" class="scroll-mt-24">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <span class="bg-slate-100 text-slate-600 p-2 rounded-lg mr-3">üèóÔ∏è</span> System Architecture
                </h2>
                <p class="mt-2 text-gray-600 max-w-4xl">
                    Designed for resilience and scalability, the architecture separates data ingestion from user-facing
                    APIs. A Python-based ingestion layer handles the "dirty work" of normalizing diverse data streams,
                    while a high-performance FastAPI backend serves clean, cached JSON and ICS feeds to users. Click the
                    components below to explore the stack.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Architecture Diagram (Interactive Grid) -->
                <div class="lg:col-span-8 space-y-4">
                    <!-- Ingestion Layer -->
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 relative">
                        <span
                            class="absolute -top-3 left-4 bg-[#F5F5F0] px-2 text-xs font-bold text-gray-400 uppercase">Ingestion
                            Layer (Async Workers)</span>
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="showArchDetail('ctftime')"
                                class="arch-node bg-white hover:bg-indigo-50 border border-gray-200 p-4 rounded-lg shadow-sm transition-all text-center group">
                                <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">üåê</div>
                                <div class="font-bold text-sm text-gray-700">CTFtime API</div>
                            </button>
                            <button onclick="showArchDetail('github')"
                                class="arch-node bg-white hover:bg-indigo-50 border border-gray-200 p-4 rounded-lg shadow-sm transition-all text-center group">
                                <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">üìÇ</div>
                                <div class="font-bold text-sm text-gray-700">GitHub Repos</div>
                            </button>
                            <button onclick="showArchDetail('scraper')"
                                class="arch-node bg-white hover:bg-indigo-50 border border-gray-200 p-4 rounded-lg shadow-sm transition-all text-center group">
                                <div class="text-2xl mb-1 group-hover:scale-110 transition-transform">üï∑Ô∏è</div>
                                <div class="font-bold text-sm text-gray-700">HTML Scraper</div>
                            </button>
                        </div>
                        <!-- Arrow Down -->
                        <div class="flex justify-center my-2 text-gray-300">‚¨áÔ∏è</div>
                        <!-- Processor -->
                        <div class="flex justify-center">
                            <button onclick="showArchDetail('celery')"
                                class="w-full max-w-md bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg shadow-md transition-all font-semibold flex items-center justify-center gap-2">
                                ‚öôÔ∏è Celery Worker + Normalizer
                            </button>
                        </div>
                    </div>

                    <!-- Storage Layer -->
                    <div class="grid grid-cols-2 gap-6">
                        <button onclick="showArchDetail('postgres')"
                            class="bg-white hover:bg-emerald-50 border border-emerald-200 p-4 rounded-xl shadow-sm transition-all flex items-center gap-4">
                            <div class="text-3xl">üóÑÔ∏è</div>
                            <div class="text-left">
                                <div class="font-bold text-gray-800">PostgreSQL</div>
                                <div class="text-xs text-gray-500">Relational Data</div>
                            </div>
                        </button>
                        <button onclick="showArchDetail('redis')"
                            class="bg-white hover:bg-red-50 border border-red-200 p-4 rounded-xl shadow-sm transition-all flex items-center gap-4">
                            <div class="text-3xl">‚ö°</div>
                            <div class="text-left">
                                <div class="font-bold text-gray-800">Redis</div>
                                <div class="text-xs text-gray-500">Cache & Queue</div>
                            </div>
                        </button>
                    </div>

                    <!-- API Layer -->
                    <div class="border border-gray-200 bg-white rounded-xl p-4 shadow-sm relative">
                        <span
                            class="absolute -top-3 left-4 bg-white px-2 text-xs font-bold text-indigo-600 uppercase border border-gray-100 rounded">Core
                            API</span>
                        <div class="flex flex-col items-center">
                            <button onclick="showArchDetail('fastapi')"
                                class="w-full bg-slate-800 hover:bg-slate-900 text-white p-3 rounded-lg shadow transition-all font-bold">
                                üöÄ FastAPI Backend
                            </button>
                            <!-- Arrow Split -->
                            <div class="flex w-full justify-around mt-2 text-gray-300 text-sm">
                                <span>‚¨áÔ∏è JSON</span>
                                <span>‚¨áÔ∏è ICS</span>
                                <span>‚¨áÔ∏è Webhook</span>
                            </div>
                            <div class="grid grid-cols-3 gap-4 w-full mt-2">
                                <div class="text-center p-2 bg-gray-50 rounded text-xs font-semibold">Next.js UI</div>
                                <div class="text-center p-2 bg-gray-50 rounded text-xs font-semibold">Calendar Feed
                                </div>
                                <div class="text-center p-2 bg-gray-50 rounded text-xs font-semibold">Discord Bot</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="lg:col-span-4">
                    <div class="bg-slate-800 text-white rounded-xl p-6 h-full shadow-lg flex flex-col">
                        <h3 class="text-xl font-bold mb-4 border-b border-slate-600 pb-2">Component Specs</h3>
                        <div id="archDetailsContent" class="flex-grow">
                            <p class="text-slate-300 italic">Select a component from the diagram to view technical
                                specifications, libraries, and security controls.</p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-600 text-xs text-slate-400">
                            SecOps Protocol: All API keys stored in .env (Docker Secrets).
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 3: Operations (ETL Pipeline) -->
        <section id="operations" class="scroll-mt-24">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <span class="bg-emerald-100 text-emerald-600 p-2 rounded-lg mr-3">üîÑ</span> Operational Pipeline
                    (ETL)
                </h2>
                <p class="mt-2 text-gray-600 max-w-4xl">
                    Data integrity is paramount. Our ETL (Extract, Transform, Load) pipeline ensures that messy,
                    timezone-ambiguous data from the wild is sanitized into a strict UTC standard before storage.
                </p>
            </div>

            <div class="glass-card rounded-xl p-8">
                <!-- Stepper Navigation -->
                <div class="flex justify-between items-center mb-8 relative">
                    <!-- Connecting Line -->
                    <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-200 -z-10 transform -translate-y-1/2"></div>

                    <button onclick="setEtlStep(0)"
                        class="etl-step active w-10 h-10 rounded-full bg-indigo-600 text-white font-bold flex items-center justify-center border-4 border-white shadow-sm hover:scale-110 transition-transform">1</button>
                    <button onclick="setEtlStep(1)"
                        class="etl-step w-10 h-10 rounded-full bg-gray-300 text-white font-bold flex items-center justify-center border-4 border-white shadow-sm hover:scale-110 transition-transform">2</button>
                    <button onclick="setEtlStep(2)"
                        class="etl-step w-10 h-10 rounded-full bg-gray-300 text-white font-bold flex items-center justify-center border-4 border-white shadow-sm hover:scale-110 transition-transform">3</button>
                    <button onclick="setEtlStep(3)"
                        class="etl-step w-10 h-10 rounded-full bg-gray-300 text-white font-bold flex items-center justify-center border-4 border-white shadow-sm hover:scale-110 transition-transform">4</button>
                </div>

                <!-- Step Content -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div>
                        <h3 id="etlTitle" class="text-xl font-bold text-gray-900 mb-2">Ingestion</h3>
                        <p id="etlDesc" class="text-gray-600 mb-4">Fetching raw data from APIs and feeds.</p>
                        <ul id="etlList" class="space-y-2 text-sm text-gray-700">
                            <!-- JS populates this -->
                        </ul>
                    </div>
                    <div
                        class="bg-gray-900 rounded-lg p-4 font-mono text-xs text-green-400 overflow-x-auto shadow-inner">
                        <div class="flex items-center gap-2 mb-2 border-b border-gray-700 pb-2">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-500 ml-auto">etl_worker.py</span>
                        </div>
                        <pre id="etlCode" class="whitespace-pre-wrap">
# Initiating CTFtime fetch...
response = requests.get(API_URL)
if response.status_code == 200:
    raw_events = response.json()
                        </pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 4: Tactical Personalization -->
        <section id="notifications" class="scroll-mt-24">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Notification Simulator -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                        <span class="bg-amber-100 text-amber-600 p-1.5 rounded mr-2">üîî</span> Alert Scoring Simulator
                    </h3>
                    <p class="text-sm text-gray-500 mb-6">
                        Notifications are filtered by a "Significance Score" to prevent alert fatigue. Adjust the
                        parameters to see how the system prioritizes an event.
                    </p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">CTF Weight (CTFtime
                                Points)</label>
                            <input type="range" id="weightInput" min="0" max="100" value="25"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                            <div class="flex justify-between text-xs text-gray-400 mt-1">
                                <span>0</span>
                                <span id="weightValue" class="font-bold text-indigo-600">25.0</span>
                                <span>100</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Is Official Conference?</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="officialInput" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500">
                                </div>
                            </label>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-600">Calculated Score:</span>
                                <span id="finalScore" class="text-2xl font-bold text-gray-900">0</span>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-400">User Threshold: 40</span>
                                <span id="notificationStatus"
                                    class="px-2 py-1 text-xs font-bold rounded bg-gray-200 text-gray-500">IGNORED</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Threat Model Checklist -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                        <span class="bg-red-100 text-red-600 p-1.5 rounded mr-2">üõ°Ô∏è</span> Security Controls
                    </h3>
                    <div class="space-y-3">
                        <div class="border border-gray-100 rounded-lg overflow-hidden">
                            <button
                                class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 transition-colors flex justify-between items-center font-medium text-sm"
                                onclick="toggleSecurity(this)">
                                <span>SSRF Protection</span>
                                <span class="text-gray-400">‚ñº</span>
                            </button>
                            <div class="hidden p-3 bg-white text-xs text-gray-600 border-t border-gray-100">
                                Scrapers operate in a restricted network namespace. Only whitelisted domains
                                (ctftime.org, githubusercontent.com) are accessible.
                            </div>
                        </div>
                        <div class="border border-gray-100 rounded-lg overflow-hidden">
                            <button
                                class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 transition-colors flex justify-between items-center font-medium text-sm"
                                onclick="toggleSecurity(this)">
                                <span>XSS Sanitization</span>
                                <span class="text-gray-400">‚ñº</span>
                            </button>
                            <div class="hidden p-3 bg-white text-xs text-gray-600 border-t border-gray-100">
                                All event descriptions are passed through Python `bleach` library to strip malicious
                                script tags before storage.
                            </div>
                        </div>
                        <div class="border border-gray-100 rounded-lg overflow-hidden">
                            <button
                                class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 transition-colors flex justify-between items-center font-medium text-sm"
                                onclick="toggleSecurity(this)">
                                <span>Calendar Spam Rate Limits</span>
                                <span class="text-gray-400">‚ñº</span>
                            </button>
                            <div class="hidden p-3 bg-white text-xs text-gray-600 border-t border-gray-100">
                                ICS feed generation is cached for 60 minutes via Redis. User endpoints rate-limited to
                                60 req/min.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 6: Timeline (Roadmap) -->
        <section id="timeline" class="mb-12 scroll-mt-24">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                    <span class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3">üìÖ</span> MVP Roadmap
                </h2>
                <p class="mt-2 text-gray-600">
                    A four-week sprint plan to reach Minimum Viable Product status, focusing on core data ingestion
                    first, followed by API development and User Interface.
                </p>
            </div>

            <div class="glass-card rounded-xl p-6">
                <div class="chart-container">
                    <canvas id="roadmapChart"></canvas>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto py-8">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm">CTF Tracker Research Platform | Based on Project Specification</p>
            <div class="mt-2 flex justify-center space-x-4">
                <span class="text-xs text-indigo-500 font-semibold bg-indigo-50 px-2 py-1 rounded">FastAPI</span>
                <span class="text-xs text-indigo-500 font-semibold bg-indigo-50 px-2 py-1 rounded">PostgreSQL</span>
                <span class="text-xs text-indigo-500 font-semibold bg-indigo-50 px-2 py-1 rounded">Next.js</span>
            </div>
        </div>
    </footer>

    <script>
        // --- DATA & STATE ---
        const colors = {
            primary: '#4F46E5', // Indigo 600
            secondary: '#10B981', // Emerald 500
            accent: '#F59E0B', // Amber 500
            bg: '#F3F4F6',
            text: '#374151'
        };

        // --- CHART.JS CONFIGURATION ---
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#6B7280';

        // 1. Intelligence Source Bubble Chart
        const ctxSource = document.getElementById('sourceChart').getContext('2d');
        const sourceChart = new Chart(ctxSource, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: 'Data Sources',
                    data: [
                        { x: 90, y: 95, r: 25, source: 'CTFtime API', type: 'API', limit: '1 req/sec' }, // High Freq, High Reliability
                        { x: 40, y: 90, r: 20, source: 'InfoSec GitHub', type: 'JSON', limit: 'None' }, // Low Freq, High Reliability
                        { x: 60, y: 50, r: 15, source: 'Public Calendars', type: 'API', limit: 'OAuth Req' },
                        { x: 20, y: 80, r: 10, source: 'CTF Writeups', type: 'Git', limit: 'None' },
                        { x: 10, y: 30, r: 10, source: 'Media CCC', type: 'RSS', limit: 'None' }
                    ],
                    backgroundColor: [
                        'rgba(79, 70, 229, 0.7)', // Indigo
                        'rgba(16, 185, 129, 0.7)', // Green
                        'rgba(245, 158, 11, 0.7)', // Amber
                        'rgba(107, 114, 128, 0.7)', // Gray
                        'rgba(239, 68, 68, 0.7)'   // Red
                    ],
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Update Frequency (Low ‚Üí Real-time)' },
                        min: 0, max: 100,
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'Data Reliability & Trust' },
                        min: 0, max: 110,
                        grid: { color: '#E5E7EB' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const raw = context.raw;
                                return `${raw.source} (${raw.type})`;
                            },
                            afterLabel: function (context) {
                                return `Limit: ${context.raw.limit}`;
                            }
                        },
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        padding: 10,
                        cornerRadius: 8
                    }
                },
                onHover: (event, activeElements) => {
                    const detailsDiv = document.getElementById('sourceDetails');
                    if (activeElements && activeElements.length > 0) {
                        const raw = sourceChart.data.datasets[0].data[activeElements[0].index];
                        detailsDiv.innerHTML = `
                            <h3 class="font-bold text-lg text-indigo-700 mb-1">${raw.source}</h3>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p><span class="font-semibold text-gray-800">Type:</span> ${raw.type}</p>
                                <p><span class="font-semibold text-gray-800">Reliability:</span> ${raw.y}%</p>
                                <p><span class="font-semibold text-gray-800">Constraints:</span> ${raw.limit}</p>
                                <p class="mt-2 text-xs italic bg-white p-2 border border-gray-100 rounded">
                                    ${getDetailsForSource(raw.source)}
                                </p>
                            </div>
                        `;
                    } else {
                        // Reset if not hovering
                        // detailsDiv.innerHTML = '<h3 class="font-bold text-lg text-gray-800 mb-2">Source Details</h3><p class="text-gray-500 text-sm italic">Hover over a bubble to see specific technical constraints.</p>';
                    }
                }
            }
        });

        function getDetailsForSource(source) {
            const map = {
                'CTFtime API': 'The Gold Standard. Use endpoints /api/v1/events/ and /api/v1/results/. requires polite throttling.',
                'InfoSec GitHub': 'Community maintained JSON files. Excellent for major conferences (Defcon, BSides). Raw Git access.',
                'Public Calendars': 'Good for local meetups, but data is often unstructured and requires heavy normalization.',
                'CTF Writeups': 'Historical archive data. Requires parsing README.md files from the ctfs/write-ups repo.',
                'Media CCC': 'Chaos Computer Club archives. Excellent for getting slides and video links post-event.'
            };
            return map[source] || 'No extra data.';
        }

        // 2. Roadmap Gantt Chart
        const ctxRoadmap = document.getElementById('roadmapChart').getContext('2d');
        const roadmapChart = new Chart(ctxRoadmap, {
            type: 'bar',
            data: {
                labels: ['Week 1: Ingestion', 'Week 2: Backend/API', 'Week 3: Frontend', 'Week 4: Users/Notifs'],
                datasets: [{
                    label: 'Milestone Progress',
                    data: [100, 75, 50, 25], // Visual placeholders for effort/completion
                    backgroundColor: [
                        '#4F46E5', // Indigo
                        '#10B981', // Emerald
                        '#F59E0B', // Amber
                        '#EF4444'  // Red
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Completion Target (%)' }
                    },
                    y: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (ctx) {
                                const tasks = [
                                    "Setup Postgres, Redis, Python. Build fetchers.",
                                    "FastAPI endpoints, ICS generation, Deployment.",
                                    "Next.js setup, Event Cards, Filter Logic.",
                                    "Auth, Save Prefs, Discord Webhook."
                                ];
                                // Label Wrapping Logic
                                const label = tasks[ctx.dataIndex];
                                const words = label.split(' ');
                                const lines = [];
                                let currentLine = words[0];
                                for (let i = 1; i < words.length; i++) {
                                    if (currentLine.length + words[i].length + 1 <= 30) {
                                        currentLine += ' ' + words[i];
                                    } else {
                                        lines.push(currentLine);
                                        currentLine = words[i];
                                    }
                                }
                                lines.push(currentLine);
                                return lines;
                            }
                        }
                    }
                }
            }
        });

        // --- INTERACTION LOGIC ---

        // 1. Architecture Details
        function showArchDetail(key) {
            const content = document.getElementById('archDetailsContent');
            const data = {
                'ctftime': {
                    title: 'CTFtime API Ingestor',
                    desc: 'Primary source for global CTF data. Fetches `/events/` endpoint. Implements strict rate limiting (1 req/sec) to respect ToS.',
                    tech: 'Python `requests` + `tenacity` for retries.'
                },
                'github': {
                    title: 'GitHub JSON Fetcher',
                    desc: 'Pulls raw JSON from `coolacid/infosec_conferences`. Uses content-hash caching to only update when commits change.',
                    tech: 'Python `httpx`, Git Raw.'
                },
                'scraper': {
                    title: 'Fallback HTML Scraper',
                    desc: 'Targeted scraper for specific major events lacking APIs (e.g., Sessionize pages). Protected by rigid failure boundaries.',
                    tech: 'Playwright (Headless Browser) + BeautifulSoup.'
                },
                'celery': {
                    title: 'Celery Workers + Normalizer',
                    desc: 'The engine room. 1. Converts all times to UTC (ISO 8601). 2. Deduplicates events based on (Name + Date) hash. 3. Validates fields.',
                    tech: 'Celery, Redis Broker, PyTZ.'
                },
                'postgres': {
                    title: 'PostgreSQL Database',
                    desc: 'Stores structured `Events` and `Users`. Uses JSONB columns for flexible metadata (tags, resource links).',
                    tech: 'PostgreSQL 14+, SQLAlchemy ORM.'
                },
                'redis': {
                    title: 'Redis Cache',
                    desc: 'Caches API responses for 60s and generated ICS feeds for 1 hour. Also acts as the message broker for Celery.',
                    tech: 'Redis 6.0'
                },
                'fastapi': {
                    title: 'FastAPI Backend',
                    desc: 'High-performance Async I/O. Serves REST endpoints (`/events`) and generates dynamic calendar files (`/feed.ics`).',
                    tech: 'FastAPI, Uvicorn, Python-ICS.'
                }
            };

            const info = data[key];
            if (info) {
                content.innerHTML = `
                    <div class="animate-fade-in">
                        <h4 class="text-lg font-bold text-indigo-400 mb-2">${info.title}</h4>
                        <p class="text-sm text-slate-300 mb-4">${info.desc}</p>
                        <div class="bg-slate-700 p-2 rounded text-xs font-mono text-emerald-400 border border-slate-600">
                            Tech: ${info.tech}
                        </div>
                    </div>
                `;
            }
        }

        // 2. ETL Stepper Logic
        function setEtlStep(stepIndex) {
            // Update UI Dots
            const steps = document.querySelectorAll('.etl-step');
            steps.forEach((s, idx) => {
                if (idx === stepIndex) {
                    s.classList.add('bg-indigo-600', 'active');
                    s.classList.remove('bg-gray-300');
                } else {
                    s.classList.remove('bg-indigo-600', 'active');
                    s.classList.add('bg-gray-300');
                }
            });

            // Content Data
            const content = [
                {
                    title: "1. Ingest",
                    desc: "Fetch raw data from prioritized sources. Priority: API > Git > RSS.",
                    list: ["GET https://ctftime.org/api/v1/events/", "GET raw.githubusercontent.com/.../2024.json"],
                    code: "# Fetching CTFtime...\nevents = requests.get(API_URL).json()\n# Fetching GitHub...\nconfs = requests.get(GIT_URL).json()"
                },
                {
                    title: "2. Normalize",
                    desc: "Sanitize data types. Convert everything to UTC. Map diverse tags to standard taxonomy.",
                    list: ["Convert 'EST'/'CEST' -> UTC", "Map 'web-exploitation' -> 'Web'", "Generate slug ID"],
                    code: "from datetime import timezone\n\nfor e in events:\n  e['start'] = parse_date(e['start']).astimezone(timezone.utc)\n  e['tags'] = normalize_tags(e['tags'])"
                },
                {
                    title: "3. Validate & Dedup",
                    desc: "Ensure data integrity. Remove duplicates based on content hash.",
                    list: ["Check Start < End Date", "Hash(title + date) to find dupes", "Discard past events (unless archiving)"],
                    code: "uid = hashlib.md5(f\"{e['title']}{e['start']}\".encode()).hexdigest()\nif db.exists(uid):\n    update_existing(uid, e)\nelse:\n    create_new(e)"
                },
                {
                    title: "4. Load & Cache",
                    desc: "Upsert into Postgres and warm up the Redis cache for API read reliability.",
                    list: ["Upsert into 'Events' Table", "Invalidate Redis Cache keys", "Trigger Notification tasks"],
                    code: "db.session.add(event_obj)\ndb.session.commit()\n\nredis.setex(f'event:{uid}', 3600, json.dumps(event_obj))"
                }
            ];

            // Update DOM
            const c = content[stepIndex];
            document.getElementById('etlTitle').innerText = c.title;
            document.getElementById('etlDesc').innerText = c.desc;

            const listEl = document.getElementById('etlList');
            listEl.innerHTML = '';
            c.list.forEach(item => {
                const li = document.createElement('li');
                li.className = "flex items-center gap-2";
                li.innerHTML = `<span class="text-indigo-500 font-bold">‚Ä∫</span> ${item}`;
                listEl.appendChild(li);
            });

            document.getElementById('etlCode').innerText = c.code;
        }

        // 3. Notification Calculator
        const weightInput = document.getElementById('weightInput');
        const weightValue = document.getElementById('weightValue');
        const officialInput = document.getElementById('officialInput');
        const finalScore = document.getElementById('finalScore');
        const statusEl = document.getElementById('notificationStatus');

        function calculateScore() {
            const weight = parseInt(weightInput.value);
            const isOfficial = officialInput.checked;
            weightValue.innerText = weight.toFixed(1);

            // Formula from report: (CTF_Weight * 2) + (Is_Official_Conf * 50)
            let score = (weight * 2) + (isOfficial ? 50 : 0);

            finalScore.innerText = score;

            if (score > 40) {
                statusEl.innerText = "üö® NOTIFICATION SENT";
                statusEl.className = "px-2 py-1 text-xs font-bold rounded bg-emerald-100 text-emerald-700";
            } else {
                statusEl.innerText = "IGNORED (Low Score)";
                statusEl.className = "px-2 py-1 text-xs font-bold rounded bg-gray-200 text-gray-500";
            }
        }

        weightInput.addEventListener('input', calculateScore);
        officialInput.addEventListener('change', calculateScore);

        // 4. Security Toggles
        function toggleSecurity(btn) {
            const content = btn.nextElementSibling;
            const arrow = btn.querySelector('span:last-child');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.innerText = '‚ñ≤';
            } else {
                content.classList.add('hidden');
                arrow.innerText = '‚ñº';
            }
        }

        function scrollToSection(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Init
        setEtlStep(0);
        calculateScore();

    </script>
</body>

</html>